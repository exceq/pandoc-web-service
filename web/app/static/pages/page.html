<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans|Raleway" rel="stylesheet">
    <link rel="stylesheet" href="/static/resume.css"/>
</head>
<body>
<div>
    <form id="form" style="float:left; margin:0; width:50%">
        <input id="user_id" type=number placeholder="Ваш user_id...">
        <textarea id="markdown" cols="90" rows="50" placeholder="# Hello"></textarea>
        <br>
        <input id="submit" type="submit" value="Открыть в новой вкладке">
        <input id="example" value="Загрузить пример резюме" type="button"/>
        <input id="download_pdf" value="Скачать в формате PDF" type="button"/>

    </form>
    <div style="float:left; margin:0; width:50%;">
        <div id="message">Preview placeholder</div>
    </div>
</div>
<a href="/static/pages/register.html">Регистрация</a>


</body>
<style>
    #message {
        zoom: 0.7;
        width: 21cm;
        height: 29.7cm;
        padding: 30mm 45mm 30mm 45mm;
        border: solid #4d4d4d 1px;
        align-self: baseline;
    }
</style>
<script>
    function delay(callback, ms) {
        let timer = 0;
        return function () {
            const context = this, args = arguments;
            clearTimeout(timer);
            timer = setTimeout(function () {
                callback.apply(context, args);
            }, ms || 0);
        };
    }

    let markdown_textarea = $('#markdown');
    let htmlPreviewCallback = function () {
        $.ajax({
            url: '/resume/preview',
            method: 'POST',
            data: JSON.stringify({markdown: markdown_textarea.val()}),
            contentType: "application/json",
            dataType: 'html',
            success: function (data) {
                $('#message').html(data);
            }
        });
    };
    markdown_textarea.keyup(delay(htmlPreviewCallback, 500));

    $('#example').click(function () {
        $.ajax({
            url: '/resume/example',
            method: 'get',
            dataType: 'html',
            success: function (data) {
                markdown_textarea.val(data);
                htmlPreviewCallback();
            }
        });
    });

    // function download(filename, text) {
    //     var pom = document.createElement('a');
    //     pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    //     pom.setAttribute('download', filename);
    //
    //     if (document.createEvent) {
    //         var event = document.createEvent('MouseEvents');
    //         event.initEvent('click', true, true);
    //         pom.dispatchEvent(event);
    //     } else {
    //         pom.click();
    //     }
    // }
    //
    // $('#download_pdf').click(function () {
    //     $.ajax({
    //         url: '/files/pdf-to-minio',
    //         method: 'post',
    //         data: JSON.stringify({markdown: markdown_textarea.val()}),
    //         contentType: "application/json",
    //         dataType: 'html',
    //         success: function (data) {
    //             download("file.pdf", data)
    //         }
    //     });
    // });

    $('#download_pdf').click(function () {
        $.ajax({
            url: '/resume/save-pdf',
            method: 'post',
            data: JSON.stringify({markdown: markdown_textarea.val(), user_id: $('#user_id').val()}),
            contentType: "application/json",
            dataType: 'html',
            success: function (data) {
                alert("Запрос на генерацию пдф отправлен. Документ будет доступен в лк.")
            },
            error: function (xhr) {
                console.log(xhr);
                let response = JSON.parse(xhr.responseText);
                let msg = "Ошибка: " + response.detail;
                console.log(msg);
                alert(msg);
            }
        });
    });
</script>
</html>